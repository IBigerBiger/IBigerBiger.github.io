<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="插件," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="前面两篇文章分别介绍了关于插件Apk中Activity与Service相关的插件化，其中两种不同的插件化方式，其中Service的生命周期没有额外的因素影响，因此我们选择了手动控制其生命周期的方式，对于Activity来说，由于他的生命周期受用户交互影响，所以我们选择还是用系统本身来控制它的生命周期。
相比Activity与Service来说，BroadcastReceiver生命周期要简单很多，">
<meta property="og:type" content="article">
<meta property="og:title" content="插件化实现（五）BroadcastReceiver插件化">
<meta property="og:url" content="http://yoursite.com/2017/03/21/插件化实现（五）BroadcastReceiver插件化/index.html">
<meta property="og:site_name" content="IBigerBiger的成长之路">
<meta property="og:description" content="前面两篇文章分别介绍了关于插件Apk中Activity与Service相关的插件化，其中两种不同的插件化方式，其中Service的生命周期没有额外的因素影响，因此我们选择了手动控制其生命周期的方式，对于Activity来说，由于他的生命周期受用户交互影响，所以我们选择还是用系统本身来控制它的生命周期。
相比Activity与Service来说，BroadcastReceiver生命周期要简单很多，">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1605450-6e469359cd34de26.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2017-03-25T07:58:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="插件化实现（五）BroadcastReceiver插件化">
<meta name="twitter:description" content="前面两篇文章分别介绍了关于插件Apk中Activity与Service相关的插件化，其中两种不同的插件化方式，其中Service的生命周期没有额外的因素影响，因此我们选择了手动控制其生命周期的方式，对于Activity来说，由于他的生命周期受用户交互影响，所以我们选择还是用系统本身来控制它的生命周期。
相比Activity与Service来说，BroadcastReceiver生命周期要简单很多，">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/1605450-6e469359cd34de26.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/03/21/插件化实现（五）BroadcastReceiver插件化/"/>





  <title> 插件化实现（五）BroadcastReceiver插件化 | IBigerBiger的成长之路 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">IBigerBiger</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/21/插件化实现（五）BroadcastReceiver插件化/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="IBigerBiger">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="IBigerBiger的成长之路">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="IBigerBiger的成长之路" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                插件化实现（五）BroadcastReceiver插件化
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-21T20:12:53+08:00">
                2017-03-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/21/插件化实现（五）BroadcastReceiver插件化/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/21/插件化实现（五）BroadcastReceiver插件化/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>前面两篇文章分别介绍了关于插件Apk中Activity与Service相关的插件化，其中两种不同的插件化方式，其中Service的生命周期没有额外的因素影响，因此我们选择了手动控制其生命周期的方式，对于Activity来说，由于他的生命周期受用户交互影响，所以我们选择还是用系统本身来控制它的生命周期。</p>
<p>相比Activity与Service来说，BroadcastReceiver生命周期要简单很多，对于一个BroadcastReceiver来说，主要的使用是注册BroadcastReceiver, 发送广播信息和接收广播信息，工欲善其事必先利其器，首先我们还是对于BroadcastReceiver相关的源码进行简单的分析。</p>
<h4 id="BroadcastReceiver相关源码分析"><a href="#BroadcastReceiver相关源码分析" class="headerlink" title="BroadcastReceiver相关源码分析"></a>BroadcastReceiver相关源码分析</h4><p>前面也有说到使用BroadcastReceiver，主要是关于注册BroadcastReceiver, 发送广播信息和接收广播信息，所以这里相关的分析也是对于这三个部分分别进行。</p>
<h5 id="注册BroadcastReceiver"><a href="#注册BroadcastReceiver" class="headerlink" title="注册BroadcastReceiver"></a>注册BroadcastReceiver</h5><p>在Android中关于BroadcastReceiver的注册，主要分为静态和动态两种</p>
<ul>
<li><p>静态注册的BroadcastReceiver会从Application启动开始就一直常驻监听，直到Application消亡。</p>
</li>
<li><p>动态注册较之前者会比较灵活，可动态地在需要监听的地方加注册，但要注意在不需要取消注册。</p>
</li>
</ul>
<p>首先分析下关于动态注册，因为动态注册相对来说比较直观，动态注册调用Context的registerReceiver方法，而这个方法的具体实现类则在ContextImpl里面，而这个方法间接调用了registerReceiverInternal方法，源码如下：</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">private Intent registerReceiverInternal(BroadcastReceiver receiver, int userId,</div><div class="line">        IntentFilter filter, String broadcastPermission,</div><div class="line">        Handler scheduler, Context context) &#123;</div><div class="line">    IIntentReceiver rd = null;</div><div class="line">    if (receiver != null) &#123;</div><div class="line">        if (mPackageInfo != null &amp;&amp; context != null) &#123;</div><div class="line">            if (scheduler == null) &#123;</div><div class="line">                scheduler = mMainThread.getHandler();</div><div class="line">            &#125;</div><div class="line">            rd = mPackageInfo.getReceiverDispatcher(</div><div class="line">                receiver, context, scheduler,</div><div class="line">                mMainThread.getInstrumentation(), true);</div><div class="line">        &#125; else &#123;</div><div class="line">            if (scheduler == null) &#123;</div><div class="line">                scheduler = mMainThread.getHandler();</div><div class="line">            &#125;</div><div class="line">            rd = new LoadedApk.ReceiverDispatcher(</div><div class="line">                    receiver, context, scheduler, null, true).getIIntentReceiver();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    try &#123;</div><div class="line">        return ActivityManagerNative.getDefault().registerReceiver(</div><div class="line">                mMainThread.getApplicationThread(), mBasePackageName,</div><div class="line">                rd, filter, broadcastPermission, userId);</div><div class="line">    &#125; catch (RemoteException e) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>又是熟悉的一幕呀，接下来是调用ActivityManagerService的registerReceiver方法，由于这个方法的内容比较多，接下来代码拆分来分析：</p>
<p><strong>①</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ProcessRecord callerApp = null;  </div><div class="line">if (caller != null) &#123;  </div><div class="line">    callerApp = getRecordForAppLocked(caller);  </div><div class="line">    if (callerApp == null) &#123;  </div><div class="line">    ...  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里获得调用registerReceiver函数的应用程序进程记录块</p>
<p><strong>②</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">List allSticky = null;  </div><div class="line"></div><div class="line">// Look for any matching sticky broadcasts...  </div><div class="line">Iterator actions = filter.actionsIterator();  </div><div class="line">if (actions != null) &#123;  </div><div class="line">  while (actions.hasNext()) &#123;  </div><div class="line">    String action = (String)actions.next();  </div><div class="line">    allSticky = getStickiesLocked(action, filter, allSticky);  </div><div class="line">  &#125;  </div><div class="line">&#125; else &#123;  </div><div class="line">  ...</div><div class="line">&#125;  </div><div class="line"></div><div class="line">// The first sticky in the list is returned directly back to  </div><div class="line">// the client.  </div><div class="line">Intent sticky = allSticky != null ? (Intent)allSticky.get(0) : null;</div></pre></td></tr></table></figure>
<p>这里先通过getStickiesLocked函数查找一下有没有对应的sticky intent列表存在。什么是Sticky Intent呢？我们在最后一次调用sendStickyBroadcast函数来发送某个Action类型的广播时，系统会把代表这个广播的Intent保存下来，这样，后来调用registerReceiver来注册相同Action类型的广播接收器，就会得到这个最后发出的广播。</p>
<p>这里，假设我们不使用sendStickyBroadcast来发送CounterService.BROADCAST_COUNTER_ACTION类型的广播，于是，这里得到的allSticky和sticky都为null了。</p>
<p><strong>③</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ReceiverList rl  = (ReceiverList)mRegisteredReceivers.get(receiver.asBinder());  </div><div class="line">if (rl == null) &#123;  </div><div class="line">    rl = new ReceiverList(this, callerApp,  </div><div class="line">    Binder.getCallingPid(),  </div><div class="line">    Binder.getCallingUid(), receiver);  </div><div class="line">    </div><div class="line">    if (rl.app != null) &#123;  </div><div class="line">        rl.app.receivers.add(rl);  </div><div class="line">    &#125; else &#123;  </div><div class="line">        ...  </div><div class="line">    &#125;  </div><div class="line">    mRegisteredReceivers.put(receiver.asBinder(), rl);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里其实就是把广播接收器receiver保存一个ReceiverList列表中，这个列表的宿主进程是rl.app，这里就是MainActivity所在的进程了，在ActivityManagerService中，用一个进程记录块来表示这个应用程序进程，它里面有一个列表receivers，专门用来保存这个进程注册的广播接收器。接着，又把这个ReceiverList列表以receiver为Key值保存在ActivityManagerService的成员变量mRegisteredReceivers中，这些都是为了方便在收到广播时，快速找到对应的广播接收器的。</p>
<p><strong>④</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">BroadcastFilter bf = new BroadcastFilter(filter, rl, permission);  </div><div class="line">rl.add(bf);  </div><div class="line">...</div><div class="line">mReceiverResolver.addFilter(bf);</div></pre></td></tr></table></figure>
<p>上面只是把广播接收器receiver保存起来了，但是还没有把它和filter关联起来，这里就创建一个BroadcastFilter来把广播接收器列表rl和filter关联起来，然后保存在ActivityManagerService中的成员变量mReceiverResolver中去。</p>
<p>到这里就分析完关于BroadcastReceiver的动态注册流程了，接下来看一下关于BroadcastReceiver的静态注册流程。</p>
<p>关于静态注册，似乎我们无从下手，并没有明确的代码注册过程，但是从上两篇文章关于PackageParser这个类的介绍和使用，我们知道系统会通过PackageParser解析Apk中的AndroidManifest.xml文件，所以系统会在解析AndroidMafest.xml的<receiver>标签（也即静态注册的广播）的时候保存相应的信息。而Apk的解析过程是在PackageManagerService中进行的，因此静态注册广播的信息存储在PackageManagerService中，这里就不分析流程了，后面也有相关的源码可以论证这个说法。</receiver></p>
<h5 id="发送与接收广播信息"><a href="#发送与接收广播信息" class="headerlink" title="发送与接收广播信息"></a>发送与接收广播信息</h5><p>由于其实这个两个部分的在源码中是在同一个方法承接起来的，所以一起分析</p>
<p>发送广播信息很简单，就是一句context.sendBroadcast()，而这个sendBroadcast方法的具体实现是在类则在ContextImpl里面，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public void sendBroadcast(Intent intent) &#123;</div><div class="line">    warnIfCallingFromSystemProcess();</div><div class="line">    String resolvedType = intent.resolveTypeIfNeeded(getContentResolver());</div><div class="line">    try &#123;</div><div class="line">        intent.prepareToLeaveProcess();</div><div class="line">        ActivityManagerNative.getDefault().broadcastIntent(</div><div class="line">                mMainThread.getApplicationThread(), intent, resolvedType, null,</div><div class="line">                Activity.RESULT_OK, null, null, null, AppOpsManager.OP_NONE, null, false, false,</div><div class="line">                getUserId());</div><div class="line">    &#125; catch (RemoteException e) &#123;</div><div class="line">        throw new RuntimeException(&quot;Failure from system&quot;, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来是调用ActivityManagerService的broadcastIntent方法，而broadcastIntent则是调用了broadcastIntentLocked方法，这个方法很长，我们分开分析</p>
<p><strong>①</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">// Figure out who all will receive this broadcast.</div><div class="line">List receivers = null;</div><div class="line">List&lt;BroadcastFilter&gt; registeredReceivers = null;</div><div class="line">// Need to resolve the intent to interested receivers...</div><div class="line">if ((intent.getFlags()&amp;Intent.FLAG_RECEIVER_REGISTERED_ONLY)</div><div class="line">         == 0) &#123;</div><div class="line">    receivers = collectReceiverComponents(intent, resolvedType, callingUid, users);</div><div class="line">&#125;</div><div class="line">if (intent.getComponent() == null) &#123;</div><div class="line">    if (userId == UserHandle.USER_ALL &amp;&amp; callingUid == Process.SHELL_UID) &#123;</div><div class="line">        // Query one target user at a time, excluding shell-restricted users</div><div class="line">        // 略</div><div class="line">    &#125; else &#123;</div><div class="line">        registeredReceivers = mReceiverResolver.queryIntent(intent,</div><div class="line">                resolvedType, false, userId);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里有两个列表receivers和registeredReceivers</p>
<ul>
<li><p>receivers是对这个广播感兴趣的静态BroadcastReceiver列表；collectReceiverComponents 通过PackageManager获取了与这个广播匹配的静态BroadcastReceiver信息</p>
</li>
<li><p>mReceiverResolver存储了动态注册的BroadcastReceiver的信息</p>
</li>
</ul>
<p><strong>②</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">BroadcastQueue queue = broadcastQueueForIntent(intent);</div><div class="line">BroadcastRecord r = new BroadcastRecord(queue, intent, callerApp,</div><div class="line">        callerPackage, callingPid, callingUid, resolvedType,</div><div class="line">        requiredPermissions, appOp, brOptions, receivers, resultTo, resultCode,</div><div class="line">        resultData, resultExtras, ordered, sticky, false, userId);</div><div class="line">...</div><div class="line">boolean replaced = replacePending &amp;&amp; queue.replaceOrderedBroadcastLocked(r);</div><div class="line">if (!replaced) &#123;</div><div class="line">    queue.enqueueOrderedBroadcastLocked(r);</div><div class="line">    queue.scheduleBroadcastsLocked();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里通过broadcastQueueForIntent匹配符合要求的所有BroadcastReceiver，然后通过scheduleBroadcastsLocked通知队列对广播进行处理，这个其实是发送一个Message，通过一系列的调用，最后调用ActivityThread的scheduleRegisteredReceiver方法，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public void scheduleRegisteredReceiver(IIntentReceiver receiver, Intent intent,  </div><div class="line">        int resultCode, String dataStr, Bundle extras, boolean ordered,  </div><div class="line">        boolean sticky) throws RemoteException &#123;  </div><div class="line">    receiver.performReceive(intent, resultCode, dataStr, extras, ordered, sticky);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个receiver具体类型是LoadedApk.ReceiverDispatcher.InnerReceiver，即定义在LoadedApk类的内部类ReceiverDispatcher里面的一个内部类InnerReceiver，这里调用它的performReceive函数，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public void performReceive(Intent intent, int resultCode, String data,</div><div class="line">        Bundle extras, boolean ordered, boolean sticky, int sendingUser) &#123;</div><div class="line">    Args args = new Args(intent, resultCode, data, extras, ordered,</div><div class="line">            sticky, sendingUser);</div><div class="line">    if (!mActivityThread.post(args)) &#123;</div><div class="line">        if (mRegistered &amp;&amp; ordered) &#123;</div><div class="line">            IActivityManager mgr = ActivityManagerNative.getDefault();</div><div class="line">            args.sendFinished(mgr);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法创建了一个Args对象，然后把它post到了mActivityThread这个Handler中；我们查看Args类的run方法,如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public void run() &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">   try &#123;</div><div class="line">        ClassLoader cl =  mReceiver.getClass().getClassLoader(); // Important!! load class</div><div class="line">        intent.setExtrasClassLoader(cl);</div><div class="line">        setExtrasClassLoader(cl);</div><div class="line">        receiver.setPendingResult(this);</div><div class="line">        receiver.onReceive(mContext, intent); // callback</div><div class="line">    &#125; catch (Exception e) &#123;</div><div class="line">    ...</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (receiver.getPendingResult() != null) &#123;</div><div class="line">        finish();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里已经调用了匹配的BroadcastReceiver的onReceive回调，完成了从发送广播信息与接收广播信息的整个流程。</p>
<h4 id="BroadcastReceiver插件化"><a href="#BroadcastReceiver插件化" class="headerlink" title="BroadcastReceiver插件化"></a>BroadcastReceiver插件化</h4><p>关于BroadcastReceiver插件化其实也是有两个点的，一个是动态注册插件中的BroadcastReceiver，另外一个是静态注册插件中的BroadcastReceiver。</p>
<p>关于BroadcastReceiver插件化，通过源码分析以及对于BroadcastReceiver的了解来看，它并没有很强的生命周期，所以其实关于BroadcastReceiver的创建我们更多可以去使用像Service的插件化方式，将创建保留在自己的手中，而不是想Activity一样去设计一套瞒天过海的方式去实现插件化。</p>
<h5 id="静态广播注册"><a href="#静态广播注册" class="headerlink" title="静态广播注册"></a>静态广播注册</h5><p>首先说一下关于静态广播的注册，我们知道系统会通过PackageParser解析Apk中的AndroidManifest.xml文件，并将静态的广播信息存储在PackageManagerService中，所以我们这里看起来是无法去实现静态广播的注册，但是实际上静态广播与动态广播并没有什么本质的区别，所以我们可以通过动态广播的方式去将静态广播注册，这样也是有缺陷的，静态BroadcastReceiver与动态BroadcastReceiver一个非常大的不同之处在于：动态BroadcastReceiver在进程死亡之后是无法接收广播的，而静态BroadcastReceiver则可以——系统会唤醒Receiver所在进程，但是这其实影响不大。</p>
<p>对于通过AndroidManifest.xml获取广播信息信息集合与上一篇文章的获取Service类似，这里就直接上代码了，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">Class&lt;?&gt; packageParserClass = Class.forName(&quot;android.content.pm.PackageParser&quot;);</div><div class="line">Method parsePackageMethod = packageParserClass.getDeclaredMethod(&quot;parsePackage&quot;, File.class, int.class);</div><div class="line"></div><div class="line">Object packageParser = packageParserClass.newInstance();</div><div class="line">Object packageObj = parsePackageMethod.invoke(packageParser, apkFile, PackageManager.GET_RECEIVERS);</div><div class="line"></div><div class="line">Field receiversField = packageObj.getClass().getDeclaredField(&quot;receivers&quot;);</div><div class="line"></div><div class="line">//获取receivers集合</div><div class="line">List receivers = (List) receiversField.get(packageObj);</div><div class="line"></div><div class="line">Class&lt;?&gt; packageParser$ActivityClass = Class.forName(&quot;android.content.pm.PackageParser$Activity&quot;);</div><div class="line">Class&lt;?&gt; packageUserStateClass = Class.forName(&quot;android.content.pm.PackageUserState&quot;);</div><div class="line">Class&lt;?&gt; userHandler = Class.forName(&quot;android.os.UserHandle&quot;);</div><div class="line">Method getCallingUserIdMethod = userHandler.getDeclaredMethod(&quot;getCallingUserId&quot;);</div><div class="line">int userId = (Integer) getCallingUserIdMethod.invoke(null);</div><div class="line">Object defaultUserState = packageUserStateClass.newInstance();</div><div class="line"></div><div class="line"></div><div class="line">Method generateReceiverInfo = packageParserClass.getDeclaredMethod(&quot;generateActivityInfo&quot;,</div><div class="line">        packageParser$ActivityClass, int.class, packageUserStateClass, int.class);</div><div class="line"></div><div class="line">Class&lt;?&gt; componentClass = Class.forName(&quot;android.content.pm.PackageParser$Component&quot;);</div><div class="line">Field intentsField = componentClass.getDeclaredField(&quot;intents&quot;);</div><div class="line"></div><div class="line">for (Object receiver : receivers) &#123;</div><div class="line">    //获取Receiver对应的 ActivityInfo</div><div class="line">    ActivityInfo info = (ActivityInfo) generateReceiverInfo.invoke(packageParser, receiver, 0, defaultUserState, userId);</div><div class="line">    //获取Receiver的IntentFilter</div><div class="line">    List&lt;? extends IntentFilter&gt; filters = (List&lt;? extends IntentFilter&gt;) intentsField.get(receiver);</div><div class="line">    sCache.put(info, filters);</div><div class="line">    ClassLoader cl = null;</div><div class="line">    if (cl == null) &#123;</div><div class="line">        File optimizedDirectoryFile = HookApplication.getContext().getDir(&quot;dex&quot;, Context.MODE_PRIVATE);</div><div class="line">        cl = new CustomClassLoader(apkFile.getPath(), optimizedDirectoryFile.getPath(), null, ClassLoader.getSystemClassLoader());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    for (IntentFilter intentFilter : filters) &#123;</div><div class="line">        BroadcastReceiver broadcastReceiver = (BroadcastReceiver) cl.loadClass(info.name).newInstance();</div><div class="line">        //注册BroadcastReceiver</div><div class="line">        context.registerReceiver(broadcastReceiver, intentFilter);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那么到这里静态广播的注册就完成了，接下来看一个动态注册</p>
<h5 id="动态注册注册"><a href="#动态注册注册" class="headerlink" title="动态注册注册"></a>动态注册注册</h5><p>动态注册的BroadcastReceiver其实可以当作一个普通的Java对象；我们完全可以用纯ClassLoader技术把插件中的Receiver加载进来。</p>
<p>最简单方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">BroadcastReceiver receiver = null;</div><div class="line">File optimizedDirectoryFile = HookApplication.getContext().getDir(&quot;dex&quot;, Context.MODE_PRIVATE);</div><div class="line">ClassLoader cl = new CustomClassLoader(getFileStreamPath(&quot;xxxx.apk&quot;).getPath(), optimizedDirectoryFile.getPath(), null, ClassLoader.getSystemClassLoader());</div><div class="line">receiver = (BroadcastReceiver) cl.loadClass(&quot;xxx.xxx.xxx.BroadcastReceiver&quot;).newInstance();</div><div class="line">registerReceiver(receiver, new IntentFilter(ACTION));</div></pre></td></tr></table></figure>
<p>这里我们直接通过获取插件Apk的ClassLoader插件中的Receiver加载进来并注册。</p>
<p>在我们认为一起都很完美的时候，如果在插件Activity中有动态注册的BroadcastReceiver的代码的话，就会发现报错，错误信息如下</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1605450-6e469359cd34de26.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Snip20170325_4.png"></p>
<p>这个报错是因为我们插件中动态注册的BroadcastReceiver并非在我们宿主的ProcessRecord进程里面，而且也并非我们上述的动态注册方式，所以我们要想方法去解决这个问题。</p>
<p>我们从调用AcitivityManagerService的registerReceiver方法参数入手，方法如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public Intent registerReceiver(IApplicationThread caller, String callerPackage,</div><div class="line">            IIntentReceiver receiver, IntentFilter filter, String permission, int userId) &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到这5个参数最有问题的是callerPackage与receiver，callerPackage这里应该使用宿主的packageName而并非是插件的packageName，接下来看一下这个receiver</p>
<p>这个receiver的实现是LoadedApk的内部类ReceiverDispatcher的内部类InnerReceiver，IIntentReceiver，这是一个接口，它的实现类是LoadedApk中的ReceiverDispatcher内部类中的InnerReceiver，我们通过反射拿到其中的mDispatcher，这是一个ReceiverDispatcher的WeakReference，然后再通过它拿到我们原始的BroadcastReceiver，它是ReceiverDispatcher中的mReceiver字段。这个IIntentReceiver可以用LoadedApk中的getReceiverDispatcher生成，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">public IIntentReceiver getReceiverDispatcher(BroadcastReceiver r,</div><div class="line">        Context context, Handler handler,</div><div class="line">        Instrumentation instrumentation, boolean registered) &#123;</div><div class="line">    synchronized (mReceivers) &#123;</div><div class="line">        LoadedApk.ReceiverDispatcher rd = null;</div><div class="line">        ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt; map = null;</div><div class="line">        if (registered) &#123;</div><div class="line">            map = mReceivers.get(context);</div><div class="line">            if (map != null) &#123;</div><div class="line">                rd = map.get(r);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (rd == null) &#123;</div><div class="line">            rd = new ReceiverDispatcher(r, context, handler,</div><div class="line">                    instrumentation, registered);</div><div class="line">            if (registered) &#123;</div><div class="line">                if (map == null) &#123;</div><div class="line">                    map = new ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;();</div><div class="line">                    mReceivers.put(context, map);</div><div class="line">                &#125;</div><div class="line">                map.put(r, rd);</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            rd.validate(context, handler);</div><div class="line">        &#125;</div><div class="line">        rd.mForgotten = false;</div><div class="line">        return rd.getIIntentReceiver();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以通过这个方法来生成一个新的IIntentReceiver来替代原始的IIntentReceiver，</p>
<p>代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line">if (&quot;registerReceiver&quot;.equals(method.getName()))&#123;</div><div class="line"></div><div class="line">    Object rawIIntentReceiver;</div><div class="line">    int indexBroadcastReceiver = 0;</div><div class="line">    for (int i = 0; i &lt; args.length; i++) &#123;</div><div class="line">        if (args[i].getClass().getName().equals(&quot;android.app.LoadedApk$ReceiverDispatcher$InnerReceiver&quot;)) &#123;</div><div class="line">            indexBroadcastReceiver = i;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String packageString;</div><div class="line">    int indexpackage = 0;</div><div class="line">    for (int i = 0; i &lt; args.length; i++) &#123;</div><div class="line">        if (args[i] instanceof String) &#123;</div><div class="line">            indexpackage = i;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    rawIIntentReceiver = args[indexBroadcastReceiver];</div><div class="line"></div><div class="line">    Class&lt;?&gt; LoadedApk$ReceiverDispatcher$InnerReceiver = Class.forName(&quot;android.app.LoadedApk$ReceiverDispatcher$InnerReceiver&quot;);</div><div class="line"></div><div class="line">    Field mDispatcherField = LoadedApk$ReceiverDispatcher$InnerReceiver.getDeclaredField(&quot;mDispatcher&quot;);</div><div class="line">    mDispatcherField.setAccessible(true);</div><div class="line">    WeakReference weakReference = (WeakReference)mDispatcherField.get(rawIIntentReceiver);</div><div class="line"></div><div class="line">    //获取ReceiverDispatcher对象</div><div class="line">    Object mDispatcher = weakReference.get();</div><div class="line"></div><div class="line">    Class&lt;?&gt; LoadedApk$ReceiverDispatcher = Class.forName(&quot;android.app.LoadedApk$ReceiverDispatcher&quot;);</div><div class="line"></div><div class="line">    Field mReceiverField = LoadedApk$ReceiverDispatcher.getDeclaredField(&quot;mReceiver&quot;);</div><div class="line">    mReceiverField.setAccessible(true);</div><div class="line"></div><div class="line">    //获取ReceiverDispatcher的mReceiver</div><div class="line">    BroadcastReceiver mReceiver = (BroadcastReceiver)mReceiverField.get(mDispatcher);</div><div class="line"></div><div class="line">    //获取ReceiverDispatcher的mActivityThread</div><div class="line">    Field mActivityThreadField = LoadedApk$ReceiverDispatcher.getDeclaredField(&quot;mActivityThread&quot;);</div><div class="line">    mActivityThreadField.setAccessible(true);</div><div class="line">    Handler mActivityThread = (Handler)mActivityThreadField.get(mDispatcher);</div><div class="line"></div><div class="line">    //获取ReceiverDispatcher的mInstrumentation</div><div class="line">    Field mInstrumentationField = LoadedApk$ReceiverDispatcher.getDeclaredField(&quot;mInstrumentation&quot;);</div><div class="line">    mInstrumentationField.setAccessible(true);</div><div class="line">    Instrumentation mInstrumentation = (Instrumentation) mInstrumentationField.get(mDispatcher);</div><div class="line"></div><div class="line">    //获取ReceiverDispatcher的mRegistered</div><div class="line">    Field mRegisteredField = LoadedApk$ReceiverDispatcher.getDeclaredField(&quot;mRegistered&quot;);</div><div class="line">    mRegisteredField.setAccessible(true);</div><div class="line">    Boolean mRegistered = (Boolean) mRegisteredField.get(mDispatcher);</div><div class="line"></div><div class="line"></div><div class="line">    Class&lt;?&gt; activityThreadClass = Class.forName(&quot;android.app.ActivityThread&quot;);</div><div class="line">    Method currentActivityThreadMethod = activityThreadClass.getDeclaredMethod(&quot;currentActivityThread&quot;);</div><div class="line">    currentActivityThreadMethod.setAccessible(true);</div><div class="line">    Object currentActivityThread = currentActivityThreadMethod.invoke(null);</div><div class="line"></div><div class="line">    Class&lt;?&gt; compatibilityInfoClass = Class.forName(&quot;android.content.res.CompatibilityInfo&quot;);</div><div class="line">    Method getPackageInfoNoCheckMethod = activityThreadClass.getDeclaredMethod(&quot;getPackageInfoNoCheck&quot;, ApplicationInfo.class, compatibilityInfoClass);</div><div class="line"></div><div class="line">    Field defaultCompatibilityInfoField = compatibilityInfoClass.getDeclaredField(&quot;DEFAULT_COMPATIBILITY_INFO&quot;);</div><div class="line">    defaultCompatibilityInfoField.setAccessible(true);</div><div class="line"></div><div class="line">    Object defaultCompatibilityInfo = defaultCompatibilityInfoField.get(null);</div><div class="line">    ApplicationInfo applicationInfo = generateApplicationInfo(new File(apkFilePath));</div><div class="line"></div><div class="line">    //获取插件的loadedApk对象</div><div class="line">    Object loadedApk = getPackageInfoNoCheckMethod.invoke(currentActivityThread, applicationInfo, defaultCompatibilityInfo);</div><div class="line"></div><div class="line">    //获取loadedApk中的getReceiverDispatcher</div><div class="line">    Method getReceiverDispatcherMethod = loadedApk.getClass().getMethod(&quot;getReceiverDispatcher&quot;, BroadcastReceiver.class, Context.class, Handler.class,</div><div class="line">            Instrumentation.class, boolean.class);</div><div class="line">    getReceiverDispatcherMethod.setAccessible(true);</div><div class="line"></div><div class="line">    //生成新的IIntentReceiver</div><div class="line">    Object rd = getReceiverDispatcherMethod.invoke(loadedApk,mReceiver,HookApplication.getContext(),mActivityThread,mInstrumentation,mRegistered);</div><div class="line"></div><div class="line">    //替换IIntentReceiver</div><div class="line">    args[indexBroadcastReceiver] = rd;</div><div class="line"></div><div class="line">    packageString = HookApplication.getContext().getPackageName();</div><div class="line"></div><div class="line">    //替换callerPackage</div><div class="line">    args[indexpackage] = packageString;</div><div class="line"></div><div class="line">    return method.invoke(mBase, args);</div><div class="line">&#125;</div><div class="line"></div><div class="line">if (&quot;unregisterReceiver&quot;.equals(method.getName()))&#123;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>经过这样设置后，就可以正确的启动，至此关于BroadcastReceiver插件化就分析完毕了。</p>
<h4 id="写在后面的话"><a href="#写在后面的话" class="headerlink" title="写在后面的话"></a>写在后面的话</h4><p>到这里基本就完成了我们插件这一系统的大部分了，本来下一篇就是关于ContentProvider的插件化相关的知识了，但是现在好像ContentProvider的使用真的是比较少的，在平时开发中，没有特殊的需求，基本这个组件就没有出现的机会，所以这里就不做关于ContentProvider的插件化的讲解了，插件化系列基本到这里就结束了，peace~~~</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/插件/" rel="tag"># 插件</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/03/15/插件化实现（四）Service插件化/" rel="next" title="插件化实现（四）Service插件化">
                <i class="fa fa-chevron-left"></i> 插件化实现（四）Service插件化
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/03/25/Android组件化(一)-架构与配置/" rel="prev" title="Android组件化(一)-架构与配置">
                Android组件化(一)-架构与配置 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          

    <!-- 多说评论框 start -->
       <div class="ds-thread" data-thread-key="<%- page.path %>" data-title="<%- page.title %>" data-url="<%- page.permalink %>"></div>  
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"ibigerbiger"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->




        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="IBigerBiger" />
          <p class="site-author-name" itemprop="name">IBigerBiger</p>
          <p class="site-description motion-element" itemprop="description">IBigerBiger的成长之路</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#BroadcastReceiver相关源码分析"><span class="nav-number">1.</span> <span class="nav-text">BroadcastReceiver相关源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#注册BroadcastReceiver"><span class="nav-number">1.1.</span> <span class="nav-text">注册BroadcastReceiver</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#发送与接收广播信息"><span class="nav-number">1.2.</span> <span class="nav-text">发送与接收广播信息</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BroadcastReceiver插件化"><span class="nav-number">2.</span> <span class="nav-text">BroadcastReceiver插件化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#静态广播注册"><span class="nav-number">2.1.</span> <span class="nav-text">静态广播注册</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#动态注册注册"><span class="nav-number">2.2.</span> <span class="nav-text">动态注册注册</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#写在后面的话"><span class="nav-number">3.</span> <span class="nav-text">写在后面的话</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">IBigerBiger</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"ibigerbiger"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


</body>
</html>
